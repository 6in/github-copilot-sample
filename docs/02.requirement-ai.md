# AI向け要件（設計方針追記）

## 設計方針（2025年5月15日 追記）
- 各機能（Searcher, Matcher, Formatter, Logger, IgnoreParserなど）はインタフェース（抽象基底クラス）で定義する。
- 各インタフェースの標準実装クラスを作成する。
- Factoryパターンを用いて、main.py等の利用側はFactory経由で必要な実装クラスをインスタンス化する。
- 依存性注入（DI）により、main.pyは各機能の具象クラスに依存しない構造とする。
- 将来的な機能拡張や差し替えが容易な構成とする。

### 主なインタフェースと実装例
- ISearcher / BfsSearcher
- IMatcher / RegexMatcher
- IFormatter / SimpleFormatter
- ILogger / SimpleLogger
- IIgnoreParser / GitignoreParser

### 推奨ファイル・フォルダ構成
src/
  interfaces/    # インタフェース定義
  implementations/ # 実装クラス
  factory/       # Factoryクラス
  utils/         # 補助関数
  main.py        # エントリポイント

### 開発タスクの進め方（抜粋）
1. インタフェース定義
2. 実装クラス作成
3. Factory作成
4. main.py雛形・依存性注入
5. 各機能詳細実装・テスト

---

# 要件定義（AIによる）

## 概要
Pythonで実装するCLIユーティリティ。指定したフォルダ配下のファイルを再帰的に探索し、検索文字列（正規表現対応）にマッチする行または範囲を出力する。

## 機能要件
1. 指定フォルダを再帰的に探索し、ファイルを検索対象とする。
2. 検索文字列は正規表現に対応し、複数行にまたがるパターンも検索可能とする。
3. コマンドライン引数で以下を指定できる：
   - 探索フォルダ（必須）
   - 検索文字列（必須）
   - 検索対象とする拡張子（任意、複数指定可）
4. 検索結果として、マッチした行または範囲を標準出力に表示する。

## 非機能要件
- Python 3.xで動作すること。
- サードパーティ製ライブラリの利用は制限しない。
- CLIとして直感的に利用できること。

## 制約事項・補足仕様
- ファイルのエンコーディングはUTF-8のみ対応とする。
- シンボリックリンクは無視し、探索対象としない。
- ファイル探索は幅優先（BFS）で行い、ファイル名順で処理する。
- 検索結果の出力は標準出力のみ対応とする。
- 検索除外パターンに対応する（例：.gitや特定ディレクトリ/ファイルを除外可能とする）。
  - 除外パターンはコマンドライン引数で指定し、ファイルフォーマットは.gitignoreと同じとする。
- 読み取り不可ファイル等のエラー発生時は、エラーログを出力し処理を継続する。
- デバッグ用オプションを追加し、詳細なログ出力を可能とする。
  - ログレベルはINFO/DEBUG/ERRORで切り替え可能とする。
- 検索対象ファイルの最大サイズやタイムアウトには制限を設けない。

## 検索結果の出力フォーマット
- 1件ごとに以下の形式で出力する：
  
  <ファイルパス>:<開始行番号>-<終了行番号> <該当行または範囲の内容>
  
  例：
  /path/to/file.py:12-12 print("Hello World")
  /path/to/file.py:20-22 def func(): ...
- 複数行にマッチした場合は、開始行番号-終了行番号で範囲を示す。
- 1行のみの場合は、開始行番号と終了行番号は同じ値とする。

## モジュール構成（見直し案）
- main.py
  - CLIエントリポイント。引数パース、全体制御、ログ初期化。
- searcher.py
  - ディレクトリ探索（BFS）、ファイルフィルタリング（拡張子・除外パターン）、シンボリックリンク無視。
- matcher.py
  - ファイル内容の正規表現検索（複数行対応）、UTF-8限定読み込み。
- formatter.py
  - 検索結果の出力フォーマット整形。
- logger.py
  - ログ出力・デバッグレベル制御（INFO/DEBUG/ERROR）。
- ignore_parser.py
  - .gitignore形式の除外パターン解析・適用。
- utils.py（必要に応じて）
  - 汎用補助関数。

src/ 配下に各モジュールを配置する。

## 必要なライブラリ
- Python 標準ライブラリ
  - os, sys, argparse, re, pathlib など
- サードパーティ製ライブラリ（必要に応じて）
  - rich（出力の装飾や強調表示を行いたい場合）
  - tqdm（進捗バー表示を行いたい場合）

標準ライブラリのみで実装可能だが、利便性や視認性向上のためにサードパーティ製ライブラリの利用も検討する。

## テストパターン（例）
1. 単一ファイル・単一行マッチ：
   - 1つのファイル内で1行だけにマッチするパターン
2. 単一ファイル・複数行マッチ：
   - 1つのファイル内で複数行にまたがる正規表現パターン
3. 複数ファイル・複数マッチ：
   - 複数ファイルでそれぞれマッチが存在する場合
4. 拡張子指定あり・なし：
   - 拡張子指定時のみ対象ファイルが絞られることを確認
   - 拡張子指定なしで全ファイルが対象となることを確認
5. マッチなし：
   - 検索条件に該当する行が存在しない場合
6. サブディレクトリ内ファイル：
   - サブディレクトリ配下のファイルも探索対象となること
7. 日本語や特殊文字を含むパターン：
   - Unicode文字列や特殊記号を含む検索
8. 大容量ファイル・大量ファイル：
   - パフォーマンスやエラー発生の有無を確認
9. 権限エラー・読み取り不可ファイル：
   - アクセス権限がないファイルが存在する場合の動作
10. 複数行正規表現の境界ケース：
    - ファイルの先頭・末尾にまたがるマッチなど
